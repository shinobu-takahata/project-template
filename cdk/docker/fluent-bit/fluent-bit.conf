[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File /fluent-bit/custom/parsers.conf
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020
    storage.path /tmp/fluent-bit/storage
    storage.sync normal
    storage.checksum off
    storage.max_chunks_up 128
    storage.backlog.mem_limit 5M

# INPUT section is omitted - FireLens automatically configures forward input

[FILTER]
    Name        parser
    Match       *
    Key_Name    log
    Parser      json
    Reserve_Data On
    Preserve_Key On

# Rewrite tag for ERROR level logs
[FILTER]
    Name        rewrite_tag
    Match       *
    Rule        $levelname ^(ERROR|CRITICAL)$ error.$TAG true
    Emitter_Name re_emitted

# Output 1: ERROR level and above to CloudWatch Logs
[OUTPUT]
    Name        cloudwatch_logs
    Match       error.*
    region      ${AWS_REGION}
    log_group_name    /ecs/backend/errors
    log_stream_prefix fargate-
    auto_create_group true
    log_key     log

# Output 2: All logs to S3
[OUTPUT]
    Name        s3
    Match       *
    region      ${AWS_REGION}
    bucket      ${LOG_BUCKET_NAME}
    total_file_size  100M
    upload_timeout   1m
    s3_key_format    /logs/year=%Y/month=%m/day=%d/hour=%H/%H%M%S-$UUID.gz
    compression      gzip
    store_dir        /tmp/fluent-bit/s3
    storage_class    STANDARD
    use_put_object   On
