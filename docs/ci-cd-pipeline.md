# GitHub Actions CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€GitHub Actionsã¨AWS OIDCèªè¨¼ã‚’ä½¿ç”¨ã—ã¦ã€ECSã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

## ğŸ“‹ æ¦‚è¦

### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Git Push       â”‚
â”‚  (main/develop)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GitHub Actions   â”‚
â”‚   Triggered      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OIDC Auth       â”‚
â”‚  with AWS        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Build Docker    â”‚
â”‚    Image         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Push to ECR     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Run Alembic      â”‚
â”‚  Migrations      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update ECS Task  â”‚
â”‚   Definition     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Deploy to ECS   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. å‰ææ¡ä»¶ã®ç¢ºèª

- CDKã‚¹ã‚¿ãƒƒã‚¯ãŒãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨
- AWS CLIãŒè¨­å®šæ¸ˆã¿ã§ã‚ã‚‹ã“ã¨
- DockerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨

### 2. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ

```bash
# GitHub Actionsè¨­å®šã®ç¢ºèªã¨æº–å‚™
./scripts/setup-github-actions.sh
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
- AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã®å–å¾—
- CDKã‚¹ã‚¿ãƒƒã‚¯ã®å‡ºåŠ›å€¤ç¢ºèª
- GitHub Secretsè¨­å®šã®ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
- (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) GitHub CLIçµŒç”±ã§ã®è‡ªå‹•è¨­å®š

### 3. GitHub Secretsã®è¨­å®š

GitHubãƒªãƒã‚¸ãƒˆãƒªã«å¿…è¦ãªSecretã‚’è¨­å®šï¼š

```bash
# GitHub CLIã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
gh secret set AWS_ACCOUNT_ID -b "YOUR_ACCOUNT_ID"

# ã¾ãŸã¯ã€GitHubã®Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§
# Settings > Secrets and variables > Actions > New repository secret
```

### 4. åˆå›ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆæ¨å¥¨ï¼‰

CDKãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ã€ã¾ãšã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ECRã«ãƒ—ãƒƒã‚·ãƒ¥ï¼š

```bash
# åˆå›ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥
./scripts/initial-push.sh
```

ç’°å¢ƒã‚’é¸æŠï¼ˆdev/prodï¼‰ã™ã‚‹ã¨ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ECRã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚

> **ğŸ’¡ æ¨å¥¨ç†ç”±**: å…ˆã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãŠãã“ã¨ã§ã€CDKãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ECSã‚¿ã‚¹ã‚¯ãŒã™ãã«èµ·å‹•ã§ãã¾ã™ã€‚

### 5. ECSè¨­å®šã®æ›´æ–°

CDKè¨­å®šã§ECSã®`desiredCount`ã‚’æ›´æ–°ï¼š

```typescript
// cdk/lib/config/dev.ts
ecs: {
  desiredCount: 2,  // 0 â†’ 2ã«å¤‰æ›´
  minCapacity: 2,   // 0 â†’ 2ã«å¤‰æ›´
  maxCapacity: 10
}
```

### 6. CDKã‚¹ã‚¿ãƒƒã‚¯ã®ãƒ‡ãƒ—ãƒ­ã‚¤

ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæº–å‚™ã§ããŸã®ã§ã€CDKã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼š

```bash
cd cdk
npx cdk deploy --all
```

ECSã‚µãƒ¼ãƒ“ã‚¹ãŒã™ãã«ã‚¿ã‚¹ã‚¯ã‚’èµ·å‹•ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### 7. è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®å®Œäº†

ä»¥é™ã€`main`ã¾ãŸã¯`develop`ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§ã€ECSã‚µãƒ¼ãƒ“ã‚¹ãŒè‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™ï¼š

```bash
git add .
git commit -m "feat: add new feature"
git push origin develop  # devç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
```

> **ğŸ’¡ è£œè¶³**: åˆå›ä»¥é™ã¯ã€GitHub ActionsãŒè‡ªå‹•çš„ã«ãƒ“ãƒ«ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã„ã¾ã™ã€‚

## ğŸ“¦ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«

### 1. åŸºæœ¬çš„ãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

**ãƒ•ã‚¡ã‚¤ãƒ«**: [.github/workflows/deploy-ecs.yml](.github/workflows/deploy-ecs.yml)

**æ©Ÿèƒ½**:
- main/developãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§è‡ªå‹•å®Ÿè¡Œ
- OIDCèªè¨¼ã«ã‚ˆã‚‹AWSã‚¢ã‚¯ã‚»ã‚¹
- Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥
- ECSã‚µãƒ¼ãƒ“ã‚¹ã®æ›´æ–°
- ãƒ‡ãƒ—ãƒ­ã‚¤å®‰å®šæ€§ã®ç¢ºèª

**ãƒˆãƒªã‚¬ãƒ¼**:
- `main` â†’ prodç’°å¢ƒ
- `develop` â†’ devç’°å¢ƒ

### 2. æ‰¿èªä»˜ããƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

**ãƒ•ã‚¡ã‚¤ãƒ«**: [.github/workflows/deploy-with-approval.yml](.github/workflows/deploy-with-approval.yml)

**æ©Ÿèƒ½**:
- ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
- devç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
- ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
- prodç’°å¢ƒã¸ã®æ‰¿èªä»˜ããƒ‡ãƒ—ãƒ­ã‚¤
- ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã®è‡ªå‹•ä½œæˆ

**ãƒ•ãƒ­ãƒ¼**:
1. `build-and-test` ã‚¸ãƒ§ãƒ–ï¼ˆãƒ†ã‚¹ãƒˆã€Lintå®Ÿè¡Œï¼‰
2. `deploy-dev` ã‚¸ãƒ§ãƒ–ï¼ˆdevç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
3. `deploy-prod` ã‚¸ãƒ§ãƒ–ï¼ˆæ‰¿èªå¾Œã«prodç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
4. `notify` ã‚¸ãƒ§ãƒ–ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®é€šçŸ¥ï¼‰

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### OIDCèªè¨¼

AWS Access Keyã‚„Secret Keyã‚’ä½¿ç”¨ã›ãšã€OIDCã§ä¸€æ™‚çš„ãªèªè¨¼æƒ…å ±ã‚’å–å¾—ï¼š

```yaml
- name: Configure AWS credentials
  uses: aws-actions/configure-aws-credentials@v4
  with:
    role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role-dev
    aws-region: ap-northeast-1
```

### ãƒ–ãƒ©ãƒ³ãƒåˆ¶é™

CDKè¨­å®šã§ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ãªãƒ–ãƒ©ãƒ³ãƒã‚’åˆ¶é™ï¼š

```typescript
// cdk/lib/config/dev.ts
github: {
  owner: 'shinobu-takahata',
  repository: 'project-template',
  branches: ['main', 'develop']  // ã“ã‚Œã‚‰ã®ãƒ–ãƒ©ãƒ³ãƒã®ã¿è¨±å¯
}
```

### IAMæ¨©é™

æœ€å°æ¨©é™ã®åŸå‰‡ã«åŸºã¥ãã€å¿…è¦ãªæ¨©é™ã®ã¿ã‚’ä»˜ä¸ï¼š
- ECR: ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒƒã‚·ãƒ¥/ãƒ—ãƒ«
- ECS: ã‚¿ã‚¹ã‚¯å®šç¾©ã®ç™»éŒ²ã¨ã‚µãƒ¼ãƒ“ã‚¹ã®æ›´æ–°
- IAM: PassRoleï¼ˆECSã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ï¼‰

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆAlembicï¼‰

### æ¦‚è¦

CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å‰ã«Alembicã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒãŒå¸¸ã«æœ€æ–°ã®çŠ¶æ…‹ã«ä¿ãŸã‚Œã¾ã™ã€‚

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ–¹æ³•

ECS Run Taskã‚’ä½¿ç”¨ã—ã¦ã€æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

**GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾‹**:

```yaml
- name: Run Database Migration
  run: |
    echo "Running database migration..."

    TASK_ARN=$(aws ecs run-task \
      --cluster backend-cluster-${{ env.ENV }} \
      --task-definition backend-${{ env.ENV }} \
      --launch-type FARGATE \
      --overrides '{
        "containerOverrides": [{
          "name": "backend",
          "command": ["alembic", "upgrade", "head"]
        }]
      }' \
      --region ap-northeast-1 \
      --query 'tasks[0].taskArn' \
      --output text)

    echo "Migration task started: $TASK_ARN"

    # ã‚¿ã‚¹ã‚¯ã®å®Œäº†ã‚’å¾…æ©Ÿ
    aws ecs wait tasks-stopped \
      --cluster backend-cluster-${{ env.ENV }} \
      --tasks $TASK_ARN \
      --region ap-northeast-1

    # ã‚¿ã‚¹ã‚¯ã®çµæœã‚’ç¢ºèª
    EXIT_CODE=$(aws ecs describe-tasks \
      --cluster backend-cluster-${{ env.ENV }} \
      --tasks $TASK_ARN \
      --region ap-northeast-1 \
      --query 'tasks[0].containers[0].exitCode' \
      --output text)

    if [ "$EXIT_CODE" != "0" ]; then
      echo "âŒ Migration failed with exit code $EXIT_CODE"
      echo "Check CloudWatch Logs: /ecs/backend-${{ env.ENV }}"
      exit 1
    fi

    echo "âœ… Migration completed successfully"
```

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¸ã®çµ„ã¿è¾¼ã¿

æ—¢å­˜ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã€ä¸Šè¨˜ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¾ã™ã€‚ECRãƒ—ãƒƒã‚·ãƒ¥å¾Œã€ECSãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ•´åˆæ€§ã‚’ä¿ã¡ã¾ã™ã€‚

**é…ç½®å ´æ‰€**:
```yaml
# .github/workflows/deploy-ecs.yml

jobs:
  deploy:
    steps:
      # ... (èªè¨¼ã€ãƒ“ãƒ«ãƒ‰ã€ECRãƒ—ãƒƒã‚·ãƒ¥)

      - name: Run Database Migration  # â† ã“ã“ã«è¿½åŠ 
        run: |
          # ä¸Šè¨˜ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

      - name: Deploy Amazon ECS task definition
        # ... (æ—¢å­˜ã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š)
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **é †åºã®é‡è¦æ€§**
   - ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ECRã«ãƒ—ãƒƒã‚·ãƒ¥
   - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œï¼ˆæ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼‰
   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ­¢
   - CloudWatch Logsã§ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ç¢ºèª

3. **å¾Œæ–¹äº’æ›æ€§**
   - ã‚«ãƒ©ãƒ å‰Šé™¤ã¯æ®µéšçš„ã«å®Ÿæ–½ï¼ˆæœªä½¿ç”¨åŒ– â†’ ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ å‰Šé™¤ï¼‰
   - NOT NULLåˆ¶ç´„ã®è¿½åŠ ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šå¾Œã«å®Ÿè¡Œ

4. **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**
   - å„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã«`downgrade()`ã‚’å®Ÿè£…
   - å¿…è¦ã«å¿œã˜ã¦`alembic downgrade`ã§å·»ãæˆ»ã—å¯èƒ½ã«

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã®ç¢ºèª**:

```bash
# CloudWatch Logsã§ã‚¨ãƒ©ãƒ¼ç¢ºèª
aws logs tail /ecs/backend-dev --follow --filter-pattern "alembic"

# ã‚¿ã‚¹ã‚¯ã®è©³ç´°ç¢ºèª
aws ecs describe-tasks \
  --cluster backend-cluster-dev \
  --tasks <TASK_ARN> \
  --region ap-northeast-1
```

## ğŸ”§ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### ç’°å¢ƒå¤‰æ•°ã®è¿½åŠ 

ã‚¿ã‚¹ã‚¯å®šç¾©ã«ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ã™ã‚‹å ´åˆï¼š

```typescript
// cdk/lib/stacks/compute-stack.ts
environment: {
  ENV: config.envName,
  LOG_LEVEL: config.envName === 'prod' ? 'INFO' : 'DEBUG',
  CUSTOM_VAR: 'value'  // è¿½åŠ 
}
```

### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®å¤‰æ›´

```yaml
- name: Deploy Amazon ECS task definition
  uses: aws-actions/amazon-ecs-deploy-task-definition@v1
  with:
    wait-for-service-stability: true
    wait-for-minutes: 15  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10åˆ†
```

### é€šçŸ¥ã®è¿½åŠ 

Slackã¸ã®é€šçŸ¥ã‚’è¿½åŠ ï¼š

```yaml
- name: Notify Slack
  uses: 8398a7/action-slack@v3
  with:
    status: ${{ job.status }}
    webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### OIDCèªè¨¼ã‚¨ãƒ©ãƒ¼

```
Error: Not authorized to perform sts:AssumeRoleWithWebIdentity
```

**è§£æ±ºæ–¹æ³•**:
1. IAMãƒ­ãƒ¼ãƒ«ã®ä¿¡é ¼é–¢ä¿‚ã‚’ç¢ºèª
2. ãƒ–ãƒ©ãƒ³ãƒåãŒè¨±å¯ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. CDKã‚¹ã‚¿ãƒƒã‚¯ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤

### ECRãƒ—ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼

```
denied: User is not authorized to perform: ecr:PutImage
```

**è§£æ±ºæ–¹æ³•**:
1. IAMãƒ­ãƒ¼ãƒ«ã«ECRæ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª
2. ECRãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª

### ECSãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—

```
service was unable to place a task
```

**è§£æ±ºæ–¹æ³•**:
1. CloudWatch Logsã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
2. ã‚¿ã‚¹ã‚¯å®šç¾©ã®ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã‚’ç¢ºèª
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šã‚’ç¢ºèª

è©³ç´°ã¯ [GitHub Actions ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰](./github-actions-deployment.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ã®ç¢ºèª

```bash
# ECSã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ç¢ºèª
aws ecs describe-services \
  --cluster backend-cluster-dev \
  --services backend-service-dev \
  --region ap-northeast-1

# ã‚¿ã‚¹ã‚¯ã®ç¢ºèª
aws ecs list-tasks \
  --cluster backend-cluster-dev \
  --service-name backend-service-dev \
  --region ap-northeast-1
```

### ãƒ­ã‚°ã®ç¢ºèª

```bash
# CloudWatch Logsã®ç¢ºèª
aws logs tail /ecs/backend-dev --follow
```

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [GitHub Actions ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰](./github-actions-deployment.md) - è©³ç´°ãªè¨­å®šæ‰‹é †
- [AWS CDK ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](../cdk/README_cdk.md) - ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆ
- [ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ README](../README/README_backend.md) - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è©³ç´°

## ğŸ¯ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥**
   - `develop`: é–‹ç™ºç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
   - `main`: æœ¬ç•ªç’°å¢ƒã¸ã®æ‰¿èªä»˜ããƒ‡ãƒ—ãƒ­ã‚¤

2. **ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°**
   - Git SHA ã‚’ã‚¿ã‚°ã¨ã—ã¦ä½¿ç”¨ï¼ˆãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ï¼‰
   - `latest`ã‚¿ã‚°ã¯è£œåŠ©çš„ã«ä½¿ç”¨

3. **ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼**
   - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…
   - ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
   - ã‚µãƒ¼ãƒ“ã‚¹å®‰å®šæ€§ã®ç¢ºèª

4. **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**
   - ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã®è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æœ‰åŠ¹åŒ–
   - ä»¥å‰ã®ã‚¿ã‚¹ã‚¯å®šç¾©ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã¸ã®æ‰‹å‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½

## ğŸ”„ æ‰‹å‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

ãƒ‡ãƒ—ãƒ­ã‚¤ã«å•é¡ŒãŒã‚ã‚‹å ´åˆã€ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼š

```bash
# ä»¥å‰ã®ã‚¿ã‚¹ã‚¯å®šç¾©ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
aws ecs list-task-definitions \
  --family-prefix backend-dev \
  --sort DESC

# ç‰¹å®šã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
aws ecs update-service \
  --cluster backend-cluster-dev \
  --service backend-service-dev \
  --task-definition backend-dev:5  # ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’æŒ‡å®š
```
