# パフォーマンス要件

## 概要
本ドキュメントは、アプリケーションのパフォーマンス要件、目標値、および最適化戦略を定義します。

## パフォーマンス目標

### レスポンスタイム

#### フロントエンド
- **初回ページロード（FCP）**: 1.5秒以内
- **インタラクティブまでの時間（TTI）**: 3秒以内
- **最大コンテンツ描画（LCP）**: 2.5秒以内
- **累積レイアウトシフト（CLS）**: 0.1以下
- **First Input Delay（FID）**: 100ms以内

#### バックエンドAPI
- **GET リクエスト**: 200ms以内
- **POST/PUT リクエスト**: 500ms以内
- **複雑なクエリ**: 1秒以内

#### データベース
- **単純クエリ**: 50ms以内
- **JOIN を含むクエリ**: 200ms以内
- **集計クエリ**: 500ms以内

### スループット

#### 同時接続数
- **通常時**: 100リクエスト/秒
- **ピーク時**: 500リクエスト/秒

#### データベース接続
- **コネクションプール**: 最小10、最大50

### 可用性
- **稼働率**: 99.9%（月間ダウンタイム約43分）
- **メンテナンス時間**: 月1回、深夜時間帯（計画的ダウンタイム）

## リソース制限

### ECS Fargate タスク

#### 開発環境
- **CPU**: 0.5 vCPU
- **メモリ**: 1 GB
- **タスク数**: 1-2

#### 本番環境
- **CPU**: 1 vCPU
- **メモリ**: 2 GB
- **タスク数**: 最小2、最大10

### Aurora PostgreSQL

#### 開発環境
- **インスタンスクラス**: db.t4g.medium
- **ストレージ**: 自動スケーリング（最大100GB）

#### 本番環境
- **インスタンスクラス**: db.r6g.large
- **ストレージ**: 自動スケーリング（最大500GB）
- **リードレプリカ**: 1台（負荷に応じて自動追加）

## スケーリング戦略

### 水平スケーリング

#### ECS Auto Scaling
- **メトリクス**: CPU使用率、メモリ使用率
- **スケールアウト条件**:
  - CPU使用率 > 70%（3分間継続）
  - メモリ使用率 > 70%（3分間継続）
- **スケールイン条件**:
  - CPU使用率 < 30%（10分間継続）
  - メモリ使用率 < 30%（10分間継続）
- **クールダウン期間**:
  - スケールアウト: 60秒
  - スケールイン: 300秒

#### Aurora Auto Scaling（リードレプリカ）
- **メトリクス**: CPU使用率
- **スケールアウト条件**: CPU使用率 > 70%（5分間継続）
- **スケールイン条件**: CPU使用率 < 30%（15分間継続）
- **最小レプリカ数**: 1
- **最大レプリカ数**: 3

### 垂直スケーリング
- **タイミング**: 定期的なパフォーマンスレビュー時
- **判断基準**: 継続的な高負荷、コスト効率
- **実施方法**: ECSタスク定義の更新、Auroraインスタンスクラス変更

## キャッシング戦略

### フロントエンド

#### ブラウザキャッシュ
- **静的アセット**: 1年（ファイル名にハッシュ含む）
- **HTML**: キャッシュなし（常に最新を取得）
- **API レスポンス**: クライアント側でキャッシュ（SWRパターン）

#### CDN（Amplify）
- **静的コンテンツ**: エッジロケーションでキャッシュ
- **キャッシュ無効化**: デプロイ時に自動

### バックエンド

#### アプリケーションレベルキャッシュ
- **頻繁にアクセスされるデータ**: メモリ内キャッシュ（TTL: 5分）
- **ユーザーセッション**: インメモリまたはRedis（将来的に検討）

#### データベースクエリキャッシュ
- **読み取り専用クエリ**: SQLAlchemyクエリキャッシュ
- **集計結果**: 定期的な集計とキャッシュ

## データベース最適化

### インデックス戦略
- **プライマリキー**: すべてのテーブル
- **外部キー**: すべてのリレーション
- **検索フィールド**: 頻繁に検索される列（email、username等）
- **複合インデックス**: 複数列での検索パターンに応じて

### クエリ最適化
- **N+1問題の回避**: Eager Loading（joinedload）
- **ページネーション**: LIMIT/OFFSET、カーソルベースページネーション
- **不要なカラムの除外**: SELECT時に必要なカラムのみ取得

### コネクションプール
- **最小接続数**: 10
- **最大接続数**: 50
- **接続タイムアウト**: 30秒
- **アイドルタイムアウト**: 300秒

## 非同期処理

### バックグラウンドタスク
- **メール送信**: 非同期処理
- **ファイル処理**: 非同期処理（大容量ファイル）
- **バッチ処理**: Step Functions によるオーケストレーション

### キュー
- **将来的な検討**: Amazon SQS、Celery
- **ユースケース**: 長時間実行タスク、リトライが必要な処理

## 監視とアラート

### CloudWatch メトリクス

#### ECS
- **CPU使用率**: 監視間隔1分
- **メモリ使用率**: 監視間隔1分
- **タスク数**: 監視間隔1分
- **ネットワークI/O**: 監視間隔5分

#### Aurora
- **CPU使用率**: 監視間隔1分
- **接続数**: 監視間隔1分
- **レプリケーションラグ**: 監視間隔1分
- **ストレージ使用量**: 監視間隔5分

#### Application Load Balancer
- **ターゲット応答時間**: 監視間隔1分
- **HTTPステータスコード**: 監視間隔1分
- **リクエスト数**: 監視間隔1分

### アラート設定

#### Critical（即座に対応が必要）
- **ECS CPU使用率 > 90%**: 5分間継続
- **ECS メモリ使用率 > 90%**: 5分間継続
- **Aurora CPU使用率 > 90%**: 5分間継続
- **5xxエラー率 > 10%**: 5分間継続
- **Aurora接続数 > 最大接続数の90%**: 3分間継続

#### Warning（注意が必要）
- **ECS CPU使用率 > 80%**: 10分間継続
- **ECS メモリ使用率 > 80%**: 10分間継続
- **Aurora CPU使用率 > 70%**: 10分間継続
- **5xxエラー率 > 5%**: 10分間継続
- **平均レスポンスタイム > 1秒**: 10分間継続

### ログ管理

#### ログレベル
- **本番環境**: INFO以上
- **開発環境**: DEBUG

#### ログ保持期間
- **CloudWatch Logs**: 14日間
- **S3アーカイブ**: 90日間（長期保存が必要な場合）

#### 構造化ログ
- **フォーマット**: JSON
- **必須フィールド**: timestamp、level、message、request_id、user_id

## 最適化チェックリスト

### フロントエンド
- [ ] 画像の最適化（WebP、適切なサイズ）
- [ ] コード分割（Dynamic Import）
- [ ] Tree Shaking（未使用コードの削除）
- [ ] Lazy Loading（画像、コンポーネント）
- [ ] フォントの最適化（Variable Fonts、Font Display）
- [ ] バンドルサイズの監視

### バックエンド
- [ ] データベースクエリの最適化
- [ ] 適切なインデックスの設定
- [ ] N+1問題の回避
- [ ] 非同期処理の活用
- [ ] レスポンスの圧縮（gzip）
- [ ] 不要なデータの除外

### インフラストラクチャ
- [ ] Auto Scalingの設定
- [ ] キャッシュ戦略の実装
- [ ] CDNの活用
- [ ] コネクションプールの最適化
- [ ] マルチAZ構成
- [ ] 適切なインスタンスサイズの選定

## パフォーマンステスト

### 負荷テスト
- **ツール**: Locust、Apache JMeter
- **実施タイミング**: 本番リリース前、大規模機能追加時
- **シナリオ**:
  - 通常負荷（100リクエスト/秒）
  - ピーク負荷（500リクエスト/秒）
  - スパイク負荷（急激な負荷増加）

### ストレステスト
- **目的**: システムの限界値の把握
- **実施方法**: 段階的に負荷を増加させる
- **確認項目**:
  - エラー率の増加ポイント
  - レスポンスタイムの劣化ポイント
  - Auto Scalingの動作

### パフォーマンスモニタリング
- **ツール**: Lighthouse CI、WebPageTest
- **実施頻度**: 毎週
- **対象**: 主要ページ（トップページ、ログインページ等）

## ボトルネック分析

### 分析手法
1. **メトリクス確認**: CloudWatch、アプリケーションログ
2. **クエリ分析**: Auroraスロークエリログ
3. **プロファイリング**: Python cProfile、React DevTools Profiler
4. **分散トレーシング**: AWS X-Ray（オプション）

### 対策の優先順位
1. **Critical**: ユーザー体験に直接影響（レスポンスタイム、エラー率）
2. **High**: リソース使用率が高い（コスト増加リスク）
3. **Medium**: 改善の余地がある（将来的な問題の予防）
4. **Low**: 最適化による効果が限定的

## コスト最適化

### リソース使用効率
- **適切なインスタンスサイズ**: 過剰スペックの回避
- **Auto Scaling**: 需要に応じたスケーリング
- **Reserved Instances**: 長期利用するリソース（検討）
- **Savings Plans**: Aurora、Fargate（検討）

### 監視
- **AWS Cost Explorer**: 月次コストレビュー
- **Cost Anomaly Detection**: 異常なコスト増加の検出
- **タグ管理**: リソースごとのコスト追跡

## 更新履歴
- 2026-01-19: 初版作成
