FROM python:3.12-slim

# 非rootユーザー作成（ホームディレクトリ付き）
RUN groupadd -r appuser && useradd -r -g appuser -m appuser

WORKDIR /app

# Node.jsインストール（claude-codeに必要）
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    && curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
    && apt-get install -y --no-install-recommends nodejs \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# claude-codeインストール
RUN npm install -g @anthropic-ai/claude-code

# uvインストール（バージョン固定）
RUN pip install --no-cache-dir uv==0.5.11

# 依存関係ファイルコピー
COPY --chown=appuser:appuser pyproject.toml ./

# 依存関係インストール
RUN uv sync

# /appディレクトリの所有権を変更
RUN chown -R appuser:appuser /app

# アプリケーションコードをコピー
COPY --chown=appuser:appuser app /app/app

# Alembic設定とマイグレーションファイルをコピー
COPY --chown=appuser:appuser alembic.ini /app/alembic.ini
COPY --chown=appuser:appuser alembic /app/alembic

# 非rootユーザーに切り替え
USER appuser

CMD ["uv", "run", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
