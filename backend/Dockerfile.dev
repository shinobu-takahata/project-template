FROM python:3.12-slim

# 非rootユーザー作成（ホームディレクトリ付き）
RUN groupadd -r appuser && useradd -r -g appuser -m appuser

WORKDIR /app

# uvインストール（バージョン固定）
RUN pip install --no-cache-dir uv==0.5.11

# 依存関係ファイルコピー
COPY --chown=appuser:appuser pyproject.toml ./

# 依存関係インストール
RUN uv sync

# /appディレクトリの所有権を変更
RUN chown -R appuser:appuser /app

# アプリケーションコードをコピー
COPY --chown=appuser:appuser app /app/app

# 非rootユーザーに切り替え
USER appuser

CMD ["uv", "run", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
