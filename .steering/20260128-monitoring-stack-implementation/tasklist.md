# タスクリスト: モニタリング基盤実装

## タスク一覧

### フェーズ1: 環境設定の更新

#### タスク1.1: env-config.tsの更新
- **ステータス**: 未着手
- **説明**: モニタリング関連の環境変数を定義
- **ファイル**: `cdk/lib/config/env-config.ts`
- **作業内容**:
  - MonitoringStackEnvインターフェースを追加
  - アラート通知先メールアドレスの定義を追加
  - ECSタスク数の閾値を追加
  - RDSのCPU使用率とストレージ使用率の閾値を追加
  - ALBのレスポンスタイム閾値を追加
- **完了条件**:
  - [ ] MonitoringStackEnvインターフェースが定義されている
  - [ ] 全ての閾値設定が型安全に定義されている
- **依存関係**: なし

#### タスク1.2: dev.tsの更新
- **ステータス**: 未着手
- **説明**: 開発環境用のモニタリング設定値を定義
- **ファイル**: `cdk/lib/config/dev.ts`
- **作業内容**:
  - monitoring セクションを追加
  - 開発環境向けの閾値を設定（本番より緩い設定）
- **完了条件**:
  - [ ] monitoringセクションが追加されている
  - [ ] 開発環境に適した閾値が設定されている
- **依存関係**: タスク1.1完了後

#### タスク1.3: prod.tsの更新
- **ステータス**: 未着手
- **説明**: 本番環境用のモニタリング設定値を定義
- **ファイル**: `cdk/lib/config/prod.ts`
- **作業内容**:
  - monitoring セクションを追加
  - 本番環境向けの閾値を設定（厳格な設定）
- **完了条件**:
  - [ ] monitoringセクションが追加されている
  - [ ] 本番環境に適した閾値が設定されている
- **依存関係**: タスク1.1完了後

### フェーズ2: ComputeStackの更新

#### タスク2.1: TargetGroup ARNのエクスポート追加
- **ステータス**: 未着手
- **説明**: ALBのTargetGroup ARNをMonitoringStackで使用できるようにエクスポート
- **ファイル**: `cdk/lib/stacks/compute-stack.ts`
- **作業内容**:
  - targetGroupの定義にID設定を追加
  - targetGroup.targetGroupArn を CfnOutput でエクスポート
  - exportName は `${envName}-target-group-arn` とする
- **完了条件**:
  - [ ] targetGroupにIDが設定されている
  - [ ] targetGroup ARNがCfnOutputでエクスポートされている
  - [ ] exportNameの命名規則が正しい
- **依存関係**: なし

### フェーズ3: MonitoringStackの新規作成

#### タスク3.1: MonitoringStack基本構造の作成
- **ステータス**: 未着手
- **説明**: MonitoringStackクラスの骨組みを作成
- **ファイル**: `cdk/lib/stacks/monitoring-stack.ts`（新規作成）
- **作業内容**:
  - MonitoringStackクラスを定義
  - コンストラクタで必要なパラメータを受け取る
  - 他のスタックへの依存関係を設定
- **完了条件**:
  - [ ] MonitoringStackクラスが作成されている
  - [ ] 必要なimport文が記述されている
  - [ ] コンストラクタのシグネチャが正しい
- **依存関係**: タスク1.1〜1.3完了後

#### タスク3.2: SNSトピックの作成
- **ステータス**: 未着手
- **説明**: アラート通知用のSNSトピックとEmailサブスクリプションを作成
- **ファイル**: `cdk/lib/stacks/monitoring-stack.ts`
- **作業内容**:
  - SNS Topicを作成（表示名: `${envName} Alarm Notifications`）
  - Email Subscriptionを追加
  - メールアドレスは設定ファイルから取得
- **完了条件**:
  - [ ] SNS Topicが作成されている
  - [ ] Email Subscriptionが設定されている
  - [ ] トピック名とサブスクリプションIDが適切に設定されている
- **依存関係**: タスク3.1完了後

#### タスク3.3: ECSサービスのアラーム作成
- **ステータス**: 未着手
- **説明**: ECSサービスのタスク数とCPU使用率のアラームを作成
- **ファイル**: `cdk/lib/stacks/monitoring-stack.ts`
- **作業内容**:
  - Running Tasks Countのアラーム作成
  - CPU Utilizationのアラーム作成
  - それぞれSNSトピックへのアクションを設定
- **完了条件**:
  - [ ] Running Tasks Countアラームが作成されている
  - [ ] CPU Utilizationアラームが作成されている
  - [ ] 両方のアラームがSNSトピックに通知される
  - [ ] 閾値が設定ファイルから正しく取得されている
- **依存関係**: タスク3.2完了後

#### タスク3.4: Auroraクラスタのアラーム作成
- **ステータス**: 未着手
- **説明**: Auroraクラスタの各種メトリクスのアラームを作成
- **ファイル**: `cdk/lib/stacks/monitoring-stack.ts`
- **作業内容**:
  - CPU Utilizationアラームの作成
  - Database Connectionsアラームの作成
  - Storage使用率アラームの作成（FreeStorageSpaceメトリクス）
  - 各アラームにSNSトピックへのアクションを設定
- **完了条件**:
  - [ ] CPU Utilizationアラームが作成されている
  - [ ] Database Connectionsアラームが作成されている
  - [ ] Storage使用率アラームが作成されている
  - [ ] 全てのアラームがSNSトピックに通知される
  - [ ] 閾値が設定ファイルから正しく取得されている
- **依存関係**: タスク3.2完了後

#### タスク3.5: ALBのアラーム作成
- **ステータス**: 未着手
- **説明**: ALBのレスポンスタイムとHTTPエラー率のアラームを作成
- **ファイル**: `cdk/lib/stacks/monitoring-stack.ts`
- **作業内容**:
  - Target Response Timeアラームの作成
  - HTTP 5xxエラー率アラームの作成
  - 各アラームにSNSトピックへのアクションを設定
- **完了条件**:
  - [ ] Target Response Timeアラームが作成されている
  - [ ] HTTP 5xxエラー率アラームが作成されている
  - [ ] 両方のアラームがSNSトピックに通知される
  - [ ] 閾値が設定ファイルから正しく取得されている
- **依存関係**: タスク3.2、タスク2.1完了後

#### タスク3.6: CloudWatch Dashboardの作成
- **ステータス**: 未着手
- **説明**: 統合監視ダッシュボードの作成
- **ファイル**: `cdk/lib/stacks/monitoring-stack.ts`
- **作業内容**:
  - CloudWatch Dashboardを作成
  - ECS、Aurora、ALBの各種メトリクスウィジェットを追加
  - ウィジェットのレイアウトを設定（x, y, width, height）
- **完了条件**:
  - [ ] CloudWatch Dashboardが作成されている
  - [ ] ECSメトリクスウィジェットが追加されている（CPUとメモリ使用率）
  - [ ] Auroraメトリクスウィジェットが追加されている（CPU、接続数、ストレージ）
  - [ ] ALBメトリクスウィジェットが追加されている（レスポンスタイム、リクエスト数、エラー率）
  - [ ] ウィジェットのレイアウトが適切に設定されている
- **依存関係**: タスク3.3〜3.5完了後

### フェーズ4: CDKアプリケーションへの統合

#### タスク4.1: app.tsへのMonitoringStack追加
- **ステータス**: 未着手
- **説明**: CDKアプリケーションにMonitoringStackをインスタンス化
- **ファイル**: `cdk/bin/app.ts`
- **作業内容**:
  - MonitoringStackをimport
  - MonitoringStackをインスタンス化
  - 依存関係を設定（NetworkStack、DatabaseStack、ComputeStackの後）
- **完了条件**:
  - [ ] MonitoringStackがimportされている
  - [ ] MonitoringStackがインスタンス化されている
  - [ ] 依存関係が正しく設定されている（addDependency）
  - [ ] 環境設定が正しく渡されている
- **依存関係**: タスク3.6完了後

### フェーズ5: 検証とデプロイ

#### タスク5.1: CDK Synthによる検証
- **ステータス**: 未着手
- **説明**: CloudFormationテンプレートの生成と検証
- **コマンド**: `cd cdk && cdk synth`
- **作業内容**:
  - cdk synthを実行
  - エラーがないことを確認
  - 生成されたテンプレートを確認
- **完了条件**:
  - [ ] cdk synthがエラーなく完了する
  - [ ] MonitoringStackのテンプレートが生成されている
  - [ ] SNS、CloudWatch、Dashboardのリソースが含まれている
- **依存関係**: タスク4.1完了後

#### タスク5.2: CDK Diffによる変更確認
- **ステータス**: 未着手
- **説明**: 既存環境との差分確認
- **コマンド**: `cd cdk && cdk diff`
- **作業内容**:
  - cdk diffを実行
  - 追加されるリソースを確認
  - 既存リソースへの影響を確認
- **完了条件**:
  - [ ] cdk diffが正常に実行される
  - [ ] 追加されるリソースが意図したものである
  - [ ] 既存リソースへの破壊的変更がない
- **依存関係**: タスク5.1完了後

#### タスク5.3: 開発環境へのデプロイ
- **ステータス**: 未着手
- **説明**: 開発環境へのMonitoringStackデプロイ
- **コマンド**: `cd cdk && cdk deploy --all`
- **作業内容**:
  - 開発環境にデプロイ
  - デプロイ完了を確認
  - CloudFormationスタックの作成を確認
- **完了条件**:
  - [ ] デプロイが正常に完了する
  - [ ] CloudFormationでMonitoringStackが作成されている
  - [ ] SNSトピックが作成されている
  - [ ] CloudWatch Alarmsが作成されている
  - [ ] CloudWatch Dashboardが作成されている
- **依存関係**: タスク5.2完了後

#### タスク5.4: モニタリング機能の動作確認
- **ステータス**: 未着手
- **説明**: デプロイしたモニタリング機能の動作確認
- **作業内容**:
  - CloudWatch Dashboardにアクセスして表示を確認
  - SNSトピックのサブスクリプション確認メールを確認
  - メール内のリンクをクリックして承認
  - 各アラームのステータスを確認
- **完了条件**:
  - [ ] CloudWatch Dashboardが正しく表示される
  - [ ] SNSサブスクリプションが承認されている
  - [ ] 全てのアラームがOK状態またはINSUFFICIENT_DATA状態である
  - [ ] メトリクスデータが表示されている（データがある場合）
- **依存関係**: タスク5.3完了後

#### タスク5.5: ドキュメント更新
- **ステータス**: 未着手
- **説明**: 永続的ドキュメントの更新確認と必要に応じた更新
- **作業内容**:
  - `docs/architecture/aws_infra.md` への影響を確認
  - 必要に応じてモニタリングセクションを追加
  - リポジトリ構造ドキュメントの確認
- **完了条件**:
  - [ ] 影響範囲が確認されている
  - [ ] 必要なドキュメント更新が完了している
- **依存関係**: タスク5.4完了後

## タスク依存関係図

```
フェーズ1: 環境設定の更新
  タスク1.1 (env-config.ts)
    ├── タスク1.2 (dev.ts)
    └── タスク1.3 (prod.ts)

フェーズ2: ComputeStackの更新
  タスク2.1 (TargetGroup ARNエクスポート)

フェーズ3: MonitoringStack作成
  タスク3.1 (基本構造) ← タスク1.1〜1.3
    └── タスク3.2 (SNSトピック)
        ├── タスク3.3 (ECSアラーム)
        ├── タスク3.4 (Auroraアラーム)
        └── タスク3.5 (ALBアラーム) ← タスク2.1
            └── タスク3.6 (Dashboard) ← タスク3.3, 3.4

フェーズ4: 統合
  タスク4.1 (app.ts更新) ← タスク3.6

フェーズ5: 検証とデプロイ
  タスク5.1 (cdk synth) ← タスク4.1
    └── タスク5.2 (cdk diff)
        └── タスク5.3 (デプロイ)
            └── タスク5.4 (動作確認)
                └── タスク5.5 (ドキュメント更新)
```

## 進捗状況サマリー

- **未着手**: 17タスク
- **進行中**: 0タスク
- **完了**: 0タスク
- **全体進捗**: 0%

## 注意事項

1. **環境設定ファイルの更新順序**: env-config.ts を最初に更新し、その後 dev.ts と prod.ts を更新する
2. **TargetGroup ARNのエクスポート**: ALBアラーム作成前に必ず完了させる
3. **SNSサブスクリプション**: デプロイ後、メール承認が必要
4. **cdk synth実行**: 各フェーズ完了後に実行して構文エラーを早期発見
5. **段階的デプロイ**: まず開発環境でテストしてから本番環境へデプロイ

## 完了条件

全てのタスクが完了し、以下の条件を満たすこと：

- [ ] MonitoringStackが正常にデプロイされている
- [ ] 全てのCloudWatch Alarmsが作成されている
- [ ] CloudWatch Dashboardが正しく表示される
- [ ] SNSトピックのサブスクリプションが承認されている
- [ ] テストアラームが正常に動作する
- [ ] 永続的ドキュメントが更新されている
